name: Create Release
on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write
  discussions: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --notes-file - <<EOF
          ## New Features
          - Fixed issue where \`$\` command in normal mode did not reach the end of the line, causing incorrect cursor placement.

          ## Previous Changes
          - Introduced \`enable_notifications\` option to control notifications for actions like enabling/disabling typewriter mode, and aligning code blocks.
          - Added new \`:TWTop\` and \`:TWBottom\` commands to align the current code block with the top or bottom of the screen, respectively.
          - Introduced \`keep_cursor_position\` option to maintain cursor's relative position within the text when using \`:TWCenter\`, \`:TWTop\`, and \`:TWBottom\`.
          - Added \`:TWCenter\` command to center the view around the current code block or function using Tree-sitter.
          - Introduced Tree-sitter as a dependency for intelligent code block detection.
          - Updated installation instructions to include Tree-sitter setup.
          - Moved \`center_block_config.lua\` to the \`utils\` folder for better organization.
          - Enhanced README with information about the \`:TWCenter\` command and Tree-sitter dependency.

          ## Core Features
          - Keeps the cursor centered on the screen while typing or navigating.
          - Simple commands to enable, disable, and toggle the typewriter mode.
          - Integrates with ZenMode and True Zen for a seamless distraction-free environment.

          For more details, please check the [README](https://github.com/joshuadanpeterson/typewriter.nvim/blob/main/README.md).
          EOF

      - name: Generate Changelog
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/releases/generate-notes \
            -F tag_name=${{ github.ref_name }} \
            -F target_commitish=main \
            -F previous_tag_name=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo '') \
            --jq .body > CHANGELOG.md

      - name: Commit and push changelog
        run: |
          git config --local user.name 'GitHub Action'
          git config --local user.email 'action@github.com'
          git add CHANGELOG.md
          git commit -m 'Update changelog' || echo "No changes to commit"
          git push
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
